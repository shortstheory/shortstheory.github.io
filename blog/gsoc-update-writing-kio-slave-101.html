<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="One in 7 Billion, Arnav's Blog">


        <title>GSoC Update(?): Writing a KIO slave 101! // One in 7 Billion // Arnav's Blog</title>


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/theme/css/pure.css">
    <link rel="stylesheet" href="/theme/css/pygments.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js"></script>
    <script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script>
</head>

<body>
    <div class="pure-g-r" id="layout">
        <div class="sidebar pure-u">
            <div class="cover-img" style="background-image: url('../images/code.png')">
                <div class="cover-body">
                    <header class="header">
                        <hgroup>
                            <img class="avatar" src="/images/profile.jpg">
                            <h1 class="brand-main"><a href="">One in 7 Billion</a></h1>
                            <p class="tagline">Arnav's Blog</p>
                                <p class="social">
                                    <a href="https://github.com/shortstheory">
                                        <i class="fa fa-github fa-3x"></i>
                                    </a>
                                    <a href="https://www.youtube.com/channel/UCzOTlzNDylDXSBxKSJlBzuQ">
                                        <i class="fa fa-youtube fa-3x"></i>
                                    </a>
                                    <a href="https://www.instagram.com/arnavdhamija">
                                        <i class="fa fa-instagram fa-3x"></i>
                                    </a>
                                </p>
                        </hgroup>
                    </header>
                </div>
            </div>
        </div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>GSoC Update(?): Writing a KIO slave 101!</h1>
                        <p class="post-meta">
                            // under                                 <a class="post-category" href="/blog/tag/gsoc.html">GSoC</a>
                                <a class="post-category" href="/blog/tag/programming.html">Programming</a>
                                <a class="post-category" href="/blog/tag/kde.html">KDE</a>
                        </p>
                </header>
            </section>
            <p>This <a href="https://summerofcode.withgoogle.com/projects/#5979393230897152">project</a>
has been going well. Though it was expectedly difficult in the beginning, I
feel like I am on the other side of the learning curve now. I will probably
make a proper update post sometime later this month. My repo for this project
can be found here: <a href="https://github.com/shortstheory/staging-kioslave">https://github.com/shortstheory/staging-kioslave</a></p>
<p>For now, this is a small tutorial for writing KDE I/O slaves (KIO slaves)
which can be used for a variety of KDE applications. KIO slaves are a great
way for accessing files from different filesystems and protocols in a neat,
uniform way across many KDE applications. Their versatility makes them
integral to the KIO library. KIO slaves have changed in their structure the
transition to KF5 and this tutorial highlights some of these differences from
preceding iterations of it.</p>
<h3>Project Structure</h3>
<p>For the purpose of this tutorial, your project source directory needs to have
the following files.</p>
<ul>
<li>kio_hello.h</li>
<li>kio_hello.cpp</li>
<li>hello.json</li>
<li>CMakeLists.txt</li>
</ul>
<p>If you don't feel like creating these yourself, just clone it from here:
<a href="https://github.com/shortstheory/kioslave-tutorial">https://github.com/shortstheory/kioslave-tutorial</a></p>
<h4>hello.json</h4>
<p>The .json file replaces the .protocol files used in KIO slaves pre KF5. The
.json file for the KIO slave specifies the properties the KIO slave will have
such as the executable path to the KIO slave on installation. The .json file
also includes properties of the slave such as being able to read from, write
to, delete from, among many others. Fields in this .json file are specified
from the <a href="https://api.kde.org/frameworks/kio/html/classKProt
ocolManager.html">KProtocolManager</a> class. For creating a KIO slave capable of showing a
directory in a file manager such as Dolphin, the listing property must be set
to true. As an example, the .json file for the Hello KIO slave described in
this tutorial looks like this:  </p>
<div class="highlight"><pre><span></span>{  
    "KDE-KIO-Protocols" : {   
        "hello": {   
            "Class": ":local",   
            "X-DocPath": "kioslave5/kio_hello.html",   
            "exec": "kf5/kio/hello",   
            "input": "none",   
            "output": "filesystem",   
            "protocol": "hello",   
            "reading": true   
        }   
    }   
}  
</pre></div>
<p>As for the CMakeLists.txt, you will need to link your KIO slave module with
KF5::KIOCore. This can be seen in the project directory.  </p>
<h4>kio_hello.h</h4>
<div class="highlight"><pre><span></span><span class="cp">#ifndef HELLO_H  </span>
<span class="cp">#define HELLO_H  </span>

<span class="cp">#include</span> <span class="cpf">&lt;kio/slavebase.h&gt;  </span><span class="cp"></span>

<span class="cm">/**  </span>
<span class="cm">  This class implements a Hello World kioslave  </span>
<span class="cm"> */</span>   
<span class="n">class</span> <span class="nl">Hello</span> <span class="p">:</span> <span class="n">public</span> <span class="n">QObject</span><span class="p">,</span> <span class="n">public</span> <span class="n">KIO</span><span class="o">::</span><span class="n">SlaveBase</span>  
<span class="p">{</span>  
    <span class="n">Q_OBJECT</span>   
<span class="nl">public</span><span class="p">:</span>  
    <span class="n">Hello</span><span class="p">(</span><span class="k">const</span> <span class="n">QByteArray</span> <span class="o">&amp;</span><span class="n">pool</span><span class="p">,</span> <span class="k">const</span> <span class="n">QByteArray</span> <span class="o">&amp;</span><span class="n">app</span><span class="p">);</span>   
    <span class="kt">void</span> <span class="nf">get</span><span class="p">(</span><span class="k">const</span> <span class="n">QUrl</span> <span class="o">&amp;</span><span class="n">url</span><span class="p">)</span> <span class="n">Q_DECL_OVERRIDE</span><span class="p">;</span>   
<span class="p">};</span>  

<span class="cp">#endif  </span>
</pre></div>
<p>The Hello KIO slave is derived from KIO::SlaveBase. The SlaveBase class has
some basic functions already implemented for the KIO slave. This can be found
in the <a href="https://api.kde.org/frameworks/kio/html/classKIO_1_1Sla
veBase.html">documentation</a>. However, most of the functions of SlaveBase are virtual
functions and have to be re-implemented for the KIO slave. In this case, we
are re-implementing the get function to print a QString when it is called by
kioclient5.  </p>
<p>In case you don't need special handling of the KIO slave's functions, you can
derive your KIO slave class directly from <a href="https://a
pi.kde.org/frameworks/kio/html/classKIO_1_1ForwardingSlaveBase.html">KIO::ForwardingSlaveBase</a>. Here,
you would only need to re-implement the rewriteUrl function to get your KIO
slave working.  </p>
<h4>kio_hello.cpp</h4>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">"hello.h"  </span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;QDebug&gt;  </span><span class="cp"></span>

<span class="n">class</span> <span class="nl">KIOPluginForMetaData</span> <span class="p">:</span> <span class="n">public</span> <span class="n">QObject</span>  
<span class="p">{</span>  
    <span class="n">Q_OBJECT</span>   
    <span class="n">Q_PLUGIN_METADATA</span><span class="p">(</span><span class="n">IID</span> <span class="s">"org.kde.kio.slave.hello"</span> <span class="kt">FILE</span> <span class="s">"hello.json"</span><span class="p">)</span>   
<span class="p">};</span>  

<span class="k">extern</span> <span class="s">"C"</span>  
<span class="p">{</span>  
    <span class="kt">int</span> <span class="n">Q_DECL_EXPORT</span> <span class="n">kdemain</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>   
    <span class="p">{</span>   
        <span class="n">qDebug</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">"Launching KIO slave."</span><span class="p">;</span>   
        <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>   
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Usage: kio_hello protocol domain-socket1 domain-socket2</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>   
            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>   
        <span class="p">}</span>   
        <span class="n">Hello</span> <span class="n">slave</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>   
        <span class="n">slave</span><span class="p">.</span><span class="n">dispatchLoop</span><span class="p">();</span>   
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>   
    <span class="p">}</span>   
<span class="p">}</span>  

<span class="kt">void</span> <span class="n">Hello</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="k">const</span> <span class="n">QUrl</span> <span class="o">&amp;</span><span class="n">url</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="n">qDebug</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">"Entering function."</span><span class="p">;</span>   
    <span class="n">mimeType</span><span class="p">(</span><span class="s">"text/plain"</span><span class="p">);</span>   
    <span class="n">QByteArray</span> <span class="nf">str</span><span class="p">(</span><span class="s">"Hello world!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>   
    <span class="n">data</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>   
    <span class="n">finished</span><span class="p">();</span>   
    <span class="n">qDebug</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">"Leaving function"</span><span class="p">;</span>   
<span class="p">}</span>  

<span class="n">Hello</span><span class="o">::</span><span class="n">Hello</span><span class="p">(</span><span class="k">const</span> <span class="n">QByteArray</span> <span class="o">&amp;</span><span class="n">pool</span><span class="p">,</span> <span class="k">const</span> <span class="n">QByteArray</span> <span class="o">&amp;</span><span class="n">app</span><span class="p">)</span>  
    <span class="o">:</span> <span class="n">SlaveBase</span><span class="p">(</span><span class="s">"hello"</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span> <span class="p">{}</span>   

<span class="cp">#include</span> <span class="cpf">"hello.moc"  </span><span class="cp"></span>
</pre></div>
<p>The .moc file is, of course, auto-generated at compilation time.  </p>
<p>As mentioned earlier, the KIO Slave's .cpp file will also require a new
KIOPluginForMetaData class to add the .json file. The following is used for
the hello KIO slave and can be used as an example:  </p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="n">KIOPluginForMetaData</span> : <span class="n">public</span> <span class="n">QObject</span>  
{  
    <span class="s">Q_OBJECT   </span>
<span class="s">    Q_</span><span class="n">PLUGIN_METADATA</span>(<span class="n">IID</span> <span class="s">"org.kde.kio.slave.hello"</span> <span class="n">FILE</span> <span class="s">"hello.json"</span>)   
};  
</pre></div>
<h4>CMakeLists.txt</h4>
<div class="highlight"><pre><span></span><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.5</span><span class="p">)</span>  
<span class="nb">set</span><span class="p">(</span><span class="s">QT_MIN_VERSION</span> <span class="s2">"5.4.0"</span><span class="p">)</span>  
<span class="nb">set</span><span class="p">(</span><span class="s">KF5_MIN_VERSION</span> <span class="s2">"5.16.0"</span><span class="p">)</span>  

<span class="nb">find_package</span><span class="p">(</span><span class="s">ECM</span> <span class="o">${</span><span class="nv">KF5_MIN_VERSION</span><span class="o">}</span> <span class="s">REQUIRED</span> <span class="s">NO_MODULE</span><span class="p">)</span>  
<span class="nb">set</span><span class="p">(</span>  
    <span class="s">CMAKE_MODULE_PATH</span>   
        <span class="o">${</span><span class="nv">CMAKE_MODULE_PATH</span><span class="o">}</span>   
        <span class="o">${</span><span class="nv">ECM_MODULE_PATH</span><span class="o">}</span>   
        <span class="o">${</span><span class="nv">ECM_KDE_MODULE_DIR</span><span class="o">}</span>   
<span class="p">)</span>  

<span class="nb">include</span><span class="p">(</span><span class="s">KDEInstallDirs</span><span class="p">)</span>  
<span class="nb">include</span><span class="p">(</span><span class="s">KDECMakeSettings</span><span class="p">)</span>  
<span class="nb">include</span><span class="p">(</span><span class="s">KDECompilerSettings</span> <span class="s">NO_POLICY_SCOPE</span><span class="p">)</span>  
<span class="nb">include</span><span class="p">(</span><span class="s">ECMSetupVersion</span><span class="p">)</span>  
<span class="nb">include</span><span class="p">(</span><span class="s">FeatureSummary</span><span class="p">)</span>  
<span class="nb">add_library</span><span class="p">(</span><span class="s">kio_hello</span> <span class="s">MODULE</span> <span class="s">hello.cpp</span><span class="p">)</span>  
<span class="nb">find_package</span><span class="p">(</span><span class="s">KF5</span> <span class="o">${</span><span class="nv">KF5_MIN_VERSION</span><span class="o">}</span> <span class="s">REQUIRED</span> <span class="s">KIO</span><span class="p">)</span>  
<span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">kio_hello</span> <span class="s">KF5::KIOCore</span><span class="p">)</span>  
<span class="nb">set_target_properties</span><span class="p">(</span><span class="s">kio_hello</span> <span class="s">PROPERTIES</span> <span class="s">OUTPUT_NAME</span> <span class="s2">"hello"</span><span class="p">)</span>  

<span class="nb">install</span><span class="p">(</span><span class="s">TARGETS</span> <span class="s">kio_hello</span> <span class="s">DESTINATION</span> <span class="o">${</span><span class="nv">KDE_INSTALL_PLUGINDIR</span><span class="o">}</span><span class="s">/kf5/kio</span> <span class="p">)</span>  
</pre></div>
<h3>Installation</h3>
<p>Simply run the following commands in the source folder:  </p>
<div class="highlight"><pre><span></span>mkdir build  
cd build  
cmake -DCMAKE_INSTALL_PREFIX=/usr -DKDE_INSTALL_USE_QT_SYS_PATHS=TRUE ..  
make  
sudo make install  
kdeinit5  
</pre></div>
<p>As shown above, we have to run kdeinit5 again so the new KIO slave is
discovered by KLauncher and can be loaded when we run a command through an
application such as kioclient5.<br/>
Testing  </p>
<p>Run:  </p>
<div class="highlight"><pre><span></span>kioclient5 'cat' 'hello:/'  
</pre></div>
<p>And the output should be:  </p>
<div class="highlight"><pre><span></span>Hello_world
</pre></div>
            <a href="#" class="go-top">Go Top</a>
<footer class="footer">
    <p>&copy; Arnav Dhamija &ndash;
        Built with <a href="https://github.com/PurePelicanTheme/pure-single">Pure Theme</a>
        for <a href="http://blog.getpelican.com/">Pelican</a>
    </p>
</footer>        </div>
    </div>
    </div>
    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script>

</body>
</html>